from website.database.models.personModels       import User
from website.controllers.validationController   import ValidationController
from werkzeug.security import generate_password_hash, check_password_hash
from flask import jsonify
from website import db

""" Retorna objeto usuário da db especificado pelo email  """
def user_by_email(email):
    try:
        return User.query.filter_by(email=email).first()
    except:
        return None

"""Gera dicionário somente com ID, EMAIL e PRIMEIRO NOME do usuário"""

def get_json(dict):
    data = {}
    data["id"]          = dict.id
    data["email"]       = dict.email
    data["name"]        = dict.name
    return data

"""Retorna todos os usuários """

def get_Users(name=""):
    data = {}
    if name:
        users = User.query.filter(User.name.like(f'%{name}%')).all()
    else:
        users = User.query.all()
    if users:
        result = []
        for u in users:
            result.append(get_json(u))

        data["message"] = "successfully fetched"
        data["data"]    = result
        return data

    data["message"] = "nothing found"
    data["data"]    = {}
    return data


"""Retorna usuário específico pelo ID no parametro da request"""

def get_user_by_id(id):
    user = User.query.get(id)
    data = {}
    if user:
        result = get_json(user)
        data["message"] = "successfully fetched"
        data["data"]    = result
        return data, 201

    data["message"] = "user don't exist"
    data["data"]    = {}
    return data, 404


"""Cadastro de usuários com validação de existência"""
def post_user(email,name,password):
    validationController    = ValidationController(email,name,password,password) 
    resp, code              = validationController.execute()

    return resp, code


"""Atualiza usuário baseado no ID, caso o mesmo exista."""


def update_user(id, email, name, password ):
    data = {}
    user = User.query.get(id)

    if not user:
        data["message"] = "user don't exist"
        data["data"]    = {}
        return data, 404

    pass_hash = generate_password_hash(password)

    if user:
        try:
            user.password   = pass_hash
            user.name       = name
            user.email      = email
            db.session.commit()
            result          = get_json(user)
            
            data["message"] = "successfully updated"
            data["data"]    = result
            return data, 201
        except:
            data["message"] = "unable to update"
            data["data"]    = {}
            return data, 500


"""Deleta usuário com base no ID da request"""


def delete_user(id):
    data = {}
    user = User.query.get(id)
    if not user:
        data["message"] = "user don't exist"
        data["data"]    = {}
        return data, 404

    if user:
        try:
            db.session.delete(user)
            db.session.commit()
            result = get_json(user)
            data["message"] = "successfully deleted"
            data["data"]    = result
            return data, 200
        except:
            data["message"] = "unable to delete"
            data["data"]    = {}
            return data, 500

